<html>
<!-- Tab Edits -->
<style>
ul.tab {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #f1f1f1;
}

/* Float the list items side by side */
ul.tab li {float: left;}

/* Style the links inside the list items */
ul.tab li a {
    display: inline-block;
    color: black;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
    transition: 0.3s;
    font-size: 17px;
}

/* Change background color of links on hover */
ul.tab li a:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
ul.tab li a:focus, .active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-top: none;
}

.ready-emphasis {
    color: #d9534f;
    font-weight: 600;
}

.reaction-label,
.reaction-equation {
    color: #0275d8;
    font-weight: 600;
}

.prompt-figure {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-top: 8px;
}

.prompt-figure img {
    max-width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
<!-- End of additions for tab edits -->

<head>
<title id="title_el">Discussion Room</title>

</head>

<body>

<link href='https://fonts.googleapis.com/css?family=Oxygen' rel='stylesheet' type='text/css'>
<link property='stylesheet' href='https://cdn.jsdelivr.net/gh/DANCECollaborative/bazaar@latest/bazaar_server/bazaar_server_lobby/bazaar/discussionnew2.css' rel='stylesheet' id='filecss' type='text/css' />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-L11A1eGZTZ9qWZ75VDV2JK1J3tOHxZdfps+AKmke7gZ0y3jR9LMwMdQ5b9kgQ0n8" crossorigin="anonymous">
<script type="text/javascript" src="https://rawgit.com/marinawang/bazaar/master/client.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" ></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="https://rawgit.com/gtomar/stylesheets/master/colors.js"></script>
<script type="text/javascript" src="https://rawgit.com/gtomar/stylesheets/master/jquery.sortable.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-5CMIGxGZHOcXERZt2cM1mjdbKjCJmtIt0dGjO18m0orb56qP9RPMdEAVnXW86PK0" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQH0ZqB0dEPNIIDl12szREOG7imBjM+W3uMgjjt7GkmR1XB/tJu6v3+gXrZ" crossorigin="anonymous"></script>

<script>
    // Update these URLs to change embedded resources.
    const RESOURCE_URLS = {
        virtualLab: "https://virtual-lab-part1.pages.dev/?name=6DDK7PNQ-part1-A", // should contain some username mapping
        virtualLab2: "https://virtual-lab-part2-1.pages.dev/?name=6DDK7PNQ-part2-A",
        virtualLab3: "https://virtual-lab-part3.pages.dev/?name=6DDK7PNQ-part3-A",
        virtualLab4: "https://virtual-lab-part4.pages.dev/?name=6DDK7PNQ-part4-A",
        scratchpad: "https://docs.google.com/document/d/1-dcX5e-W3BJgPEYThgZypnG57ejX0QkvivVgV9mYdms/edit?tab=t.0",
        tutorial: "https://munano.org/virtual-lab-hints-template/?name=student-1"
    };

    const PART_TAB_IDS = ['tab-virtualLab1-li', 'tab-virtualLab2-li', 'tab-virtualLab3-li', 'tab-virtualLab4-li'];
    const PART_CONTENT_IDS = ['Part 1', 'Part 2', 'Part 3', 'Part 4'];

    function resolveResourceUrl(template, roomName) {
        return template.replace(/\{ROOM\}/g, roomName || "");
    }

    function activateTab(tabLinkEl, targetId) {
        var tabcontent = document.getElementsByClassName("tabcontent");
        for (var i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        var tablinks = document.getElementsByClassName("tablinks");
        for (var j = 0; j < tablinks.length; j++) {
            tablinks[j].classList.remove("active");
        }
        if (targetId) {
            var target = document.getElementById(targetId);
            if (target) {
                target.style.display = "block";
            }
        }
        if (tabLinkEl) {
            tabLinkEl.classList.add("active");
        }
    }

    function getPartIndexFromSelector(selector) {
        if (!selector) { return -1; }
        var normalized = selector.replace(/^#/, '');
        for (var i = 0; i < PART_TAB_IDS.length; i++) {
            if (PART_TAB_IDS[i].toLowerCase() === normalized.toLowerCase()) {
                return i;
            }
        }
        return -1;
    }

    function setActivePart(index) {
        if (index < 0 || index >= PART_TAB_IDS.length) { return; }
        PART_TAB_IDS.forEach(function(tabId, idx) {
            var tab = document.getElementById(tabId);
            var contentId = PART_CONTENT_IDS[idx];
            var content = document.getElementById(contentId);
            if (!tab || !content) { return; }
            if (idx === index) {
                tab.style.display = '';
                var link = tab.querySelector('.tablinks');
                activateTab(link, contentId);
            } else {
                tab.style.display = 'none';
                var otherLink = tab.querySelector('.tablinks');
                if (otherLink) {
                    otherLink.classList.remove("active");
                }
                content.style.display = 'none';
            }
        });
        var ul = document.querySelector('ul.tab');
        var activeTab = document.getElementById(PART_TAB_IDS[index]);
        if (ul && activeTab) {
            ul.insertBefore(activeTab, ul.firstElementChild);
        }
        reorderTabs();
    }

    function hidePart(index) {
        if (index < 0 || index >= PART_TAB_IDS.length) { return; }
        var tab = document.getElementById(PART_TAB_IDS[index]);
        var content = document.getElementById(PART_CONTENT_IDS[index]);
        if (tab) {
            tab.style.display = 'none';
            var link = tab.querySelector('.tablinks');
            if (link) {
                link.classList.remove("active");
            }
        }
        if (content) {
            content.style.display = 'none';
        }
    }

    function handlePartTabAction(action, selector) {
        var idx = getPartIndexFromSelector(selector);
        if (idx === -1) { return false; }
        if (action === 'hide') {
            hidePart(idx);
        } else {
            setActivePart(idx);
        }
        return true;
    }

    function renderMath(target) {
        if (!target) {
            target = document.body;
        }
        if (window.renderMathInElement) {
            window.renderMathInElement(target, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "\\(", right: "\\)", display: false},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false
            });
        }
    }

    window.addEventListener('load', function() {
        renderMath(document.body);
    });

    var windowHasFocus = true;
    var unreadMessages = 0;
    var lastDate = null;
    var spreadsheet = /spreadsheet=([a-zA-Z0-9_\\-]+)/g.exec(location.search);
    //if (!spreadsheet) alert("Spreadsheet is not loaded properly: "+location.search);
    //else spreadsheet = spreadsheet[1];
    
    var entityMap = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
        "/": "&#x2F;",
      };

      function escapeHTML(string) {
        return String(string).replace(/[&<>"'\/]/g, function (s) {
          return entityMap[s];
        });
      }

    function highlightImportantPhrases(html) {
        if (!html) {
            return html;
        }
        var container = document.createElement('div');
        container.innerHTML = html;

        injectPromptFigures(container);
        applyHighlightPattern(container, /(ready:part\d+)/gi, 'ready-emphasis');
        applyHighlightPattern(container, /(reaction:\s*)/gi, 'reaction-label');
        applyHighlightPattern(container, /(?:\b[A-Za-z0-9()]+\b(?:\s*\+\s*\b[A-Za-z0-9()]+\b)*)\s*(?:->|â†’)\s*(?:\b[A-Za-z0-9()]+\b(?:\s*\+\s*\b[A-Za-z0-9()]+\b)*)/gi, 'reaction-equation');

        return container.innerHTML;
    }

    function injectPromptFigures(root) {
        var placeholder = /\[\[IMAGE:PARTNER_COOP_HINT\]\]/i;
        var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
        var nodesToReplace = [];
        while (walker.nextNode()) {
            var node = walker.currentNode;
            if (placeholder.test(node.nodeValue)) {
                nodesToReplace.push(node);
            }
        }
        nodesToReplace.forEach(function(node) {
            var html = node.nodeValue.replace(placeholder, '').trim();
            var fragment = document.createDocumentFragment();
            if (html.length) {
                fragment.appendChild(document.createTextNode(html + ' '));
            }
            var figure = document.createElement('div');
            figure.className = 'prompt-figure';
            var img = document.createElement('img');
            img.src = 'https://i.postimg.cc/5y6rPc9g/Screenshot-2025-11-06-at-8-30-11-PM.png';
            img.alt = 'Hidden concentration example';
            figure.appendChild(img);
            fragment.appendChild(figure);
            node.parentNode.replaceChild(fragment, node);
        });
    }

    function applyHighlightPattern(root, regex, className) {
        function traverse(node) {
            var child = node.firstChild;
            while (child) {
                var next = child.nextSibling;
                if (child.nodeType === Node.TEXT_NODE) {
                    replaceTextNode(child, regex, className);
                } else if (child.nodeType === Node.ELEMENT_NODE && child.tagName !== 'SCRIPT' && child.tagName !== 'STYLE') {
                    traverse(child);
                }
                child = next;
            }
        }
        traverse(root);
    }

    function replaceTextNode(textNode, regex, className) {
        var text = textNode.nodeValue;
        regex.lastIndex = 0;
        var match;
        var lastIndex = 0;
        var fragments = [];
        while ((match = regex.exec(text)) !== null) {
            if (match.index > lastIndex) {
                fragments.push(document.createTextNode(text.slice(lastIndex, match.index)));
            }
            var span = document.createElement('span');
            span.className = className;
            span.textContent = match[0];
            fragments.push(span);
            lastIndex = regex.lastIndex;
            if (!regex.global) {
                break;
            }
        }
        if (fragments.length) {
            if (lastIndex < text.length) {
                fragments.push(document.createTextNode(text.slice(lastIndex)));
            }
            var fragment = document.createDocumentFragment();
            fragments.forEach(function(part) {
                fragment.appendChild(part);
            });
            textNode.parentNode.replaceChild(fragment, textNode);
        }
    }
	
    function showConvText()
    {
        res = "";
        conv = document.getElementById("conversation");
        for (var i = 0; i < conv.childNodes.length; i++) {
            if (conv.childNodes[i].className.indexOf("message_line") == -1) continue;
            var user = conv.childNodes[i].getElementsByClassName("user");
            var timestamp = conv.childNodes[i].getElementsByClassName("date");
            var message = conv.childNodes[i].getElementsByClassName("message");
            for (var j = 0; j < user.length; j++) res += user[j].textContent + " ";
            if (timestamp.length > 0) res += "("+timestamp[0].textContent+")";
            if (message.length > 0) res += ": "+message[0].textContent.replace("\n"," ");
            res += "\n";
        }
        document.getElementById("conversation_text").value = res;

        // Highlight
        if (document.body.createTextRange) {
            range = document.body.createTextRange();
            range.moveToElementText(document.getElementById("conversation_text"));
            range.select();
        } else if (window.getSelection) {
            selection = window.getSelection();        
            range = document.createRange();
            range.selectNodeContents(document.getElementById("conversation_text"));
            selection.removeAllRanges();
            selection.addRange(range);
        }

        document.getElementById("conversation_text_div").style.display = "block";
    }

    function hideConvText()
    {
        document.getElementById("conversation_text_div").style.display = "none";
    }
		
    function formatDisplayName(name) {
        if (!name) { return name; }
        var match = /.+_([A-Za-z])$/.exec(name);
        if (match && match[1]) {
            return "Student " + match[1].toUpperCase();
        }
        return name;
    }

    function appendMessage(timestamp, username, text, color) 
    {
       if(!color)
       {
          color = getUserColor(username);
       }
        var displayName = formatDisplayName(username);

        var messageClass = (username=='VirtualProfessor' ? ' message_agent' : '');
        var $line = $('<div/>', { 'class': 'message_line' + messageClass });
        var $info = $('<div/>', { 'class': 'info' });
        if (color)
        {
            $info.css('background-color', color);
        }
        $info.append($('<div/>', { 'class': 'user' }).text(displayName));
        $info.append($('<div/>', { 'class': 'date' }).text(timestamp.toLocaleTimeString()));
        var decoratedText = highlightImportantPhrases(text);
        var $message = $('<div/>', { 'class': 'message' }).html(decoratedText);
        $line.append($info).append($message);
        $('#conversation').append($line).append('<br/>');
        renderMath($line[0]);
        noticeNewMessage();
        if(lastDate > timestamp)
          lastDate = timestamp;
    }

    function appendNote(timestamp, username, text, color) 
    {
       if(!color)
       {
          color = getUserColor(username);
       }
        var displayName = formatDisplayName(username);

        var $line = $('<div/>', { 'class': 'message_line' });
        var $info = $('<div/>', { 'class': 'info' });
        if (color)
        {
            $info.css('background-color', color);
        }
        $info.append($('<div/>', { 'class': 'user' }).text(displayName));
        var decoratedNote = highlightImportantPhrases(text);
        $info.append($('<div/>', { 'class': 'user' }).css('padding-left','5px').html(decoratedNote));
        $info.append($('<div/>', { 'class': 'date' }).text(timestamp.toLocaleTimeString()));
        $line.append($info);
        $('#conversation').append($line).append('<br/>');
        renderMath($line[0]);
        noticeNewMessage();
        if(lastDate > timestamp)
          lastDate = timestamp;
    }

    var anchorID = 0;
    function appendImage(timestamp, username, image_url, color) 
    {
       if(!color)
       {
          color = getUserColor(username);
       }
        var displayName = formatDisplayName(username);
        var anchor = 'sharedItem'+(anchorID++)
        
        var $anchor = $('<a/>', { id: anchor });
        var $line = $('<div/>', { 'class': 'image_line' });
        var $info = $('<div/>', { 'class': 'image_info' });
        if (color)
        {
            $info.css('background-color', color);
        }
        $info.append($('<div/>', { 'class': 'user' }).text(displayName));
        $info.append($('<div/>', { 'class': 'date' }).text(timestamp.toLocaleTimeString()));
        var $imgWrapper = $('<div/>').append($('<a/>', { href: image_url, target: 'blank' }).append($('<img/>', { 'class': 'shared_image', src: image_url })));
        $line.append($info).append($imgWrapper);

        $('#images').append($anchor).append($line).append('<br/>');
        renderMath($line[0]);
        noticeNewMessage();
        if(lastDate > timestamp)
            lastDate = timestamp;
        
        return anchor;

    }

    
    function reorderTabs() {
        var ul = document.querySelector('ul.tab');
        if (!ul) { return; }
        var scratchpad = document.getElementById('tab-scratchpad-li');
        var tutorial = document.getElementById('tab-tutorial-li');
        var activePart = PART_TAB_IDS.map(function(id) {
            return document.getElementById(id);
        }).find(function(tab) {
            return tab && tab.style.display !== 'none';
        });
        if (activePart && ul.firstElementChild !== activePart) {
            ul.insertBefore(activePart, ul.firstElementChild);
        }
        if (scratchpad) { ul.appendChild(scratchpad); }
        if (tutorial) { ul.appendChild(tutorial); }
    }

    function appendHTML(timestamp, username, html, color) 
    {
       if(!color)
       {
          color = getUserColor(username);
       }
        var displayName = formatDisplayName(username);
        var anchor = 'sharedItem'+(anchorID++)
        
        var $anchor = $('<a/>', { id: anchor });
        var $line = $('<div/>', { 'class': 'image_line' });
        var $info = $('<div/>', { 'class': 'image_info' });
        if (color)
        {
            $info.css('background-color', color);
        }
        $info.append($('<div/>', { 'class': 'user' }).text(displayName));
        $info.append($('<div/>', { 'class': 'date' }).text(timestamp.toLocaleTimeString()));
        var $content = $(html);
        $line.append($info).append($content);
        
        $('#images').append($anchor).append($line).append('<br/>');
        renderMath($line[0]);
        
        $('.sortable').sortable();		
        $('.exclude').sortable({
                items: ':not(.disabled)'
        });
        noticeNewMessage();
        if(lastDate > timestamp)
            lastDate = timestamp;
        return anchor;
    }

    function getMultimodalValue(field, data) 
    {
    	var fields = data.split(";%;");
    	var numFields = fields.length; 	
// 		console.log("getMultimodalValue - search field: " + field);   		
// 		console.log("getMultimodalValue - data: " + data);   	
// 		console.log("getMultimodalValue - numFields: " + numFields.toString());
    	var i = 0; 
    	var value = ""; 
    	while (i < numFields) {
    		var fieldWithValue = fields[i].split(":::");   
// 			console.log("getMultimodalValue - fieldWithValue: " + fieldWithValue);   
    		i =	i + 1; 	
    		if (fieldWithValue[0] == field) {
//     			console.log("getMultimodalValue - field found");  
    			value = fieldWithValue[1];
//     			console.log("getMultimodalValue - value: " + value);  
    			i = numFields;
    		}
    	}
    	return value;    
    }


	// var socket = io.connect(chatserver_url, {
    //     path: '/bazaar'
    // });
    const urlParams = new URLSearchParams(location.search);
    // const socketPath =
    const socket = io({
        path: '/bazsocket',
        query: {
          ltik: urlParams.get('ltik')
        }
    });

	var users = {};
	var user = 'You'
	var room = 'Here'
        var id  = 'NA'

	// on connection to server, ask for user's name with an anonymous callback
	socket.on('connect', function(){
        // call the server-side function 'adduser' and send one parameter (value of prompt)
	groups = /\/(chat|observe|code)(\/tmp)?(?:\/([^\/]+)?)(?:\/([^\/]*))(?:\/([^\/]*))(?:\/([^\/]*))?/.exec(location.pathname);
		
        live_chat = groups[1] == "chat";
		  
        if(live_chat)
        {
            temp = groups[2] && groups[2].length > 0;
            room = groups[3];
            user = groups[5];
            id = groups[4];
            perspective = groups[6];
            if(!user)
                user = prompt("Hi! please enter your name (first name and last initial) to continue..", "");
            //prompt(room + " " + user + " " + temp + " " + id);
            socket.emit('adduser', room, user, false, id, perspective);
        }
        else
	{
            socket.emit('snoop', room, id);
            $('input,textarea').prop('disabled', true);
	}
        $('#roomname').text(room);   

        document.getElementById('scratchpad').src = resolveResourceUrl(RESOURCE_URLS.scratchpad, room);
        document.getElementById('virtualLab').src  = resolveResourceUrl(RESOURCE_URLS.virtualLab, room);
        document.getElementById('virtualLab2').src = resolveResourceUrl(RESOURCE_URLS.virtualLab2, room);
        document.getElementById('virtualLab3').src = resolveResourceUrl(RESOURCE_URLS.virtualLab3, room);
        document.getElementById('virtualLab4').src = resolveResourceUrl(RESOURCE_URLS.virtualLab4, room);
        document.getElementById('tutorial').src = RESOURCE_URLS.tutorial;
        });
	

	// listener, whenever the server emits 'updatechat', this updates the chat body
	socket.on('updatechat', function (username, data) 
	{
		// Intercept optional inline UI commands sent in-band via chat.
		// Format options:
		//   1) JSON wrapped with [[CMD ...]] e.g., [[CMD {"action":"show","selectors":["#el1"]}]]
		//   2) Simple string e.g., [[CMD show:#el1,#el2]] or [[CMD hide:.className]]
		if (typeof data === 'string' && data.indexOf('[[CMD') === 0) {
			try {
				var inner = data.replace(/^\[\[CMD\s*/, '').replace(/\s*\]\]$/, '');
				var cmd = null;
				try { cmd = JSON.parse(inner); } catch (e) { cmd = inner; }
				applyUICommand(cmd);
				// Do not display command messages in the conversation.
				return;
			} catch (e) {
				// If parsing fails, fall through to normal rendering.
			}
		}

		if (data.search("multimodal:::true;%;") > -1) {
// 			console.log("updatechat - multimodal message found");
			username = getMultimodalValue("from",data);
			data = getMultimodalValue("speech",data);
		} else {
// 			console.log("updatechat - multimodal message NOT found");
		}
// 		console.log("updatechat - username: " + username);
// 		console.log("updatechat - data:     " + data);
        appendMessage(new Date(), username, data);
		$('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
	});
	
    // listener, whenever the server emits 'updateimage', this updates the image list
	socket.on('updatehtml', function (username, html) 
	{
        anchor = appendHTML(new Date(), username, html);
        appendNote(new Date(), username, 'has shared an <a href="#'+anchor+'">item.</a>');
		$('#images').stop().animate({ scrollTop: $("#images")[0].scrollHeight}, 500);	
	});
	
	
    // listener, whenever the server emits 'updateimage', this updates the image list
	socket.on('updateimage', function (username, image_url) 
	{
        anchor = appendImage(new Date(), username, image_url);
        appendNote(new Date(), username, 'has shared an <a href="#'+anchor+'">image/URL.</a>');
		$('#images').stop().animate({ scrollTop: $("#images")[0].scrollHeight}, 500);	
	});
	
	socket.on('dump_history', function (backlog) 
	{
	    for(i = 0; i < backlog.length; i++)
	    {
	       entry = backlog[i];
	       stamp = new Date(entry["timestamp"]);
               if(stamp < lastDate)
			  continue;
	       if(entry["type"] == "image")
	       {
                anchor = appendImage(new Date(entry["timestamp"]), entry["username"], entry["content"]);	
                appendNote(new Date(entry["timestamp"]), entry["username"], 'has shared an <a href="#'+anchor+'">image/URL.</a>');
            }
	       else if(entry["type"] == "html")
	       {
                anchor = appendHTML(new Date(entry["timestamp"]), entry["username"], entry["content"]);	
                appendNote(new Date(entry["timestamp"]), entry["username"], 'has shared an <a href="#'+anchor+'">item.</a>');
            }
            else if(entry.type == "presence")
                appendNote(new Date(entry.timestamp), entry.username,  (entry.content == "leave"? " has disconnected." : " has joined the discussion."));	 
            else if(entry.type == "ready")
                    ;
                    //appendNote(new Date(entry.timestamp), entry.username, (entry.content == "ready")?"thinks the team is ready.":"isn't ready yet.");
            else if(entry.type == "private")
                appendMessage(new Date(entry["timestamp"]), entry.username+" (Private Message)", entry["content"], getUserColor(entry.username));	 	 
            else
                appendMessage(new Date(entry["timestamp"]), entry.username, entry["content"]);	 
        }

		$('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
        $('#images').stop().animate({ scrollTop: $("#images")[0].scrollHeight}, 500);

			   lastDate = new Date();
	});

	// Listen for out-of-band UI commands from the agent/server.
	// Agents can emit Socket.IO event 'sendcommandeventwithroom' which the server
	// relays to clients as 'sendcommandevent'. The payload can be JSON or a simple string.
	socket.on('sendcommandevent', function (command) {
		try { applyUICommand(command); } catch (e) { /* no-op */ }
	});

	// Applies a UI command to show/hide/toggle elements or add/remove classes.
    function applyUICommand(command) {
        var cmdObj = command;
        if (typeof command === 'string') {
            // support simple forms like "show:#id,.cls" or "hide:.x"
            var m = command.match(/^(show|hide|toggle|addClass|removeClass)\s*:\s*(.*)$/i);
			if (m) {
				cmdObj = { action: m[1].toLowerCase(), selectors: m[2].split(/\s*,\s*/) };
			} else {
				// try JSON in string form
				try { cmdObj = JSON.parse(command); } catch (e) { return; }
			}
		}

        if (!cmdObj) return;
        var action = (cmdObj.action || cmdObj.op || '').toLowerCase();
        var selectors = cmdObj.selectors || cmdObj.targets || [];
        if (typeof selectors === 'string') selectors = selectors.split(/\s*,\s*/);

        var affectsTabs = false;
        selectors.forEach(function(sel) {
            var trimmed = (sel || '').trim();
            if (!trimmed) { return; }
            if (/^#?tab-virtualLab[1234]-li$/i.test(trimmed)) {
                affectsTabs = handlePartTabAction(action, trimmed) || affectsTabs;
                return;
            }
            try {
                var nodes = document.querySelectorAll(sel);
                nodes.forEach(function(el) {
                    switch (action) {
                        case 'show': el.style.display = 'initial'; break;
                        case 'hide': el.style.display = 'none'; break;
                        case 'toggle': el.style.display = (el.style.display === 'none') ? 'initial' : 'none'; break;
                        case 'addclass': if (cmdObj.class) el.classList.add(cmdObj.class); break;
                        case 'removeclass': if (cmdObj.class) el.classList.remove(cmdObj.class); break;
                        default: break;
                    }
                });
            } catch (e) { /* ignore bad selectors */ }
        });
        if (affectsTabs && (action === 'show' || action === 'hide' || action === 'toggle')) {
            reorderTabs();
        }
    }
	
	    // listener, whenever the server emits 'updaterooms', this updates the room list
	socket.on('updaterooms', function (rooms, my_room) 
	{
		$('#roomname').text(my_room);
	});
	
		    // listener, whenever the server emits 'updateimage', this updates the user list
	socket.on('updateusers', function (my_users) 
	{
	   users = my_users;
	   // console.log(users);
	});
	


	    // listener, whenever the server emits 'updatepresence', this updates the image list
	socket.on('updatepresence', function (username, data) 
	{
		if (data.search("multimodal:::true;%;") > -1) {
// 			console.log("// updatepresence - multimodal message found - username: " + username + "   data: " + data);
			username = getMultimodalValue("from",data);
			data = getMultimodalValue("presence",data);
		} else {
// 			console.log("updatechat - multimodal message NOT found");
		}
// 		console.log("updatepresence, username after processing: " + username);
// 		console.log("updatepresence: data after processing:     " + data);
		appendNote(new Date(), username,  (data == "leave"? " has disconnected." : " has joined the discussion."));	
		$('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
	});
		

	
    // listener, whenever the server emits 'updatechat', this updates the chat body
	socket.on('update_global_ready', function (ready_state) 
	{
	   if(ready_state == 'unready')
	   {
            $('#ready_button').removeClass("toggled");
           }
	});
	
	// listener, whenever the server emits 'update_private_chat', this updates the chat body
	socket.on('update_private_chat', function (username, data) 
	{		
		if (data.search("multimodal:::true;%;") > -1) {
			console.log("updatechat - multimodal message found");
			username = getMultimodalValue("from",data);
			data = getMultimodalValue("speech",data);
		} else {
			console.log("update_private_chat - multimodal message NOT found");
		}
		console.log("update_private_chat - username: " + username);
		console.log("update_private_chat - data:     " + data);
        appendMessage(new Date(), username+' (Private Message)', data, getUserColor(username));
		$('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
	});
	
		// listener, when the server emits 'sendfile', this logs the message and otherwise ignores it
	socket.on('sendfile', function (username, data) 
	{
// 		console.log("sendfile - username: " + username);
// 		console.log("sendfile - data:     " + data);
	});
	
	
	function switchRoom(room)
	{
		socket.emit('switchRoom', room);
	}

    function sendReady(is_ready)
    {
        socket.emit('ready', is_ready?'ready':'unready'); //'ready' or 'unready'         
    }
    
    function sendMessage()
    {
            var message = $('#data').val();
			//$('#data').val('');
			// tell server to execute 'sendchat' and send along one parameter
			
			$('#data').val('');
			
			message = escapeHTML(message)
			
			if(message && message.length > 0)
			{
    			socket.emit('sendchat', message);
		        $('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
		}
    }

    function shareImage()
    {
         var imageurl = $('#image_url_input').val();
         
         $('#image_url_input').val('');
         
         if(imageurl && imageurl.length > 0)
         {
            match = /http(s)?:\/\//.exec(imageurl)
            console.log(match)
            if(match == null || match.index != 0)
            {
                imageurl = "http://"+imageurl;
            }
            socket.emit('sendimage', imageurl);  

            $('#conversation').stop().animate({ scrollTop: $("#conversation")[0].scrollHeight}, 500);
            $('#images').stop().animate({ scrollTop: $("#images")[0].scrollHeight}, 500);
         }
    }

	// on load of page
	$(function(){
		// when the client clicks SEND
		$('#datasend').click( function() 
		{
            sendMessage();
		});
		
		
		// when the client clicks READY
		$('#ready_button').click( function() 
		{
			$('#ready_button').toggleClass("toggled");
			sendReady($('#ready_button').hasClass("toggled"));
			//appendNote(new Date(), "You", "think we're ready.", getUserColor(user)); 
		});

		$('#conv_message').click(function() {
			sendMessage();
		});

		// when the client hits ENTER on their keyboard
		$('#data').keypress(function(e) {
			if(e.which == 13 && !(e.altKey || e.shiftKey)) 
			{
				e.preventDefault();
				sendMessage();
			}
		});
		
		// when the client hits ENTER on their keyboard
		$('#image_url_input').keypress(function(e) {
			if(e.which == 13) 
			{
				e.preventDefault();
				shareImage();			
			}
		});
		
		
		// when the client clicks SEND IMAGE
		$('#imagesend').click( function() 
		{
				shareImage();
		});
	});
	
    $(window).focus(function() 
    {

        windowHasFocus = true;
        unreadMessages = 0;
        updateTitle();
    });
  
    //listen for browser events so we know to update the document title
    $(window).blur(function() 
    {

        windowHasFocus = false;
        updateTitle();
    });

    //we want to show a count of unread messages when the window does not have focus
    function updateTitle()
    {
      if (unreadMessages) 
      {
        document.title = "(" + unreadMessages.toString() + ") Discussion Room "+room;
      }
      else 
      {
        document.title = "Discussion Room "+room;
      }
    }
    
    function noticeNewMessage()
    {


	if(!windowHasFocus)
        {
            unreadMessages++;
	    
            updateTitle();
        }
    }

    function blinker() {
        $('.blinker').fadeIn(2000);
        setTimeout(function() {$('.blinker').fadeOut(2000);}, 10000);
    }
    setInterval(blinker,30000);

</script>


<div id="everything">

    <div id="image_column">
<!-- Edits by @sreechas for multiple tabs -->
    <ul class="tab">
    <li id="tab-virtualLab1-li"><a href="#" class="tablinks" onclick="openTab(event, 'Part 1')">Part 1</a></li>
    <li id="tab-virtualLab2-li" style="display:none"><a href="#" class="tablinks" onclick="openTab(event, 'Part 2')">Part 2</a></li>
    <li id="tab-virtualLab3-li" style="display:none"><a href="#" class="tablinks" onclick="openTab(event, 'Part 3')">Part 3</a></li>
    <li id="tab-virtualLab4-li" style="display:none"><a href="#" class="tablinks" onclick="openTab(event, 'Part 4')">Part 4</a></li>
    <li id="tab-scratchpad-li"><a href="#" class="tablinks" onclick="openTab(event, 'Scratchpad')">Scratchpad</a></li>
    <li id="tab-tutorial-li"><a href="#" class="tablinks" onclick="openTab(event, 'VirtualLabTutorial')">VirtualLab Tutorial</a></li>
    </ul>
    
   <div id="Part 1" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="virtualLab" width="100%" height="100%" style="border:0;"></iframe></div>
      </div>
    </div>

   <div id="Part 2" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="virtualLab2" width="100%" height="100%" style="border:0;"></iframe></div>
      </div>
    </div>

   <div id="Part 3" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="virtualLab3" width="100%" height="100%" style="border:0;"></iframe></div>
      </div>
    </div>

   <div id="Part 4" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="virtualLab4" width="100%" height="100%" style="border:0;"></iframe></div>
      </div>
    </div>

   <div id="Scratchpad" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="scratchpad" width="100%" height="100%"></iframe></div>
      </div>
    </div>

   <div id="VirtualLabTutorial" class="tabcontent">
      <div id="image_container" class="container">
        <div id="images" class="scrollable"><iframe id="tutorial" width="100%" height="100%" style="border:0;"></iframe></div>
      </div>
    </div>

    <script>
    function openTab(evt, tabId) {
      activateTab(evt.currentTarget, tabId);
    }

    document.addEventListener("DOMContentLoaded", function() {
      setActivePart(0);
      reorderTabs();
    });
    </script>
<!-- End of tab edits -->

    </div>

    <div id="conversation_column">
        <h2 id="conversation_header" class="header">Discussion</h2>
        <div id="conversation_container" class="container">
            <div id="conversation" class="scrollable"></div>
        </div>
        <div id="controls" class="control">
            <div id="message_div"> <textarea id="data"></textarea></div>
            <!--  <div id="messagebutton_div"> -->
               <!--  <input class="button" type="button" id="datasend" value="Send Message" /> -->
                <!--  <input class="button" type="button" id="ready_button" value="Ready"/> -->
            <!--  </div> -->
            <!--  <div class="blinker">Click the "Ready" button when you are ready to move on to the next step.</div> -->
            <div><input class="button" type="button" id="conv_message" value="Send" /></div>
        </div>
    </div>
    
    <h2 id="roomname">Room</h2>


</div>

<div id="conversation_text_div">
    <button type="button" onclick="hideConvText();">X</button>
    <h3>You can copy and paste this log to a separate file to save.</h3>
    <textarea id="conversation_text" disabled></textarea>
</div>

</body>
</html>
